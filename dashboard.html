<!DOCTYPE html>
<html>
<head>
  <title>Fillout to Referral Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .submission { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
    .email { font-weight: bold; color: #007bff; }
    .link { margin: 10px 0; }
    .link a { 
      display: inline-block; 
      padding: 8px 16px; 
      background: #007bff; 
      color: white; 
      text-decoration: none; 
      border-radius: 4px;
      margin-right: 10px;
    }
    .link a:hover { background: #0056b3; }
    .bookmarklet { 
      display: inline-block; 
      padding: 8px 16px; 
      background: #28a745; 
      color: white; 
      text-decoration: none; 
      border-radius: 4px;
      margin-right: 10px;
      cursor: pointer;
    }
    .bookmarklet:hover { background: #1e7e34; }
    .copy-button {
      display: inline-block; 
      padding: 8px 16px; 
      background: #ffc107; 
      color: #212529; 
      text-decoration: none; 
      border-radius: 4px;
      margin-right: 10px;
      cursor: pointer;
    }
    .copy-button:hover { background: #e0a800; }
    .timestamp { color: #666; font-size: 0.9em; }
    .instructions { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .setup-instructions { background: #e7f3ff; padding: 15px; border-radius: 4px; margin: 20px 0; }
    .setup-instructions h3 { margin-top: 0; }
  </style>
</head>
<body>
  <h1>Fillout to Referral x LPC Dashboard</h1>
  <div style="margin-bottom: 20px; display: flex; gap: 10px;">
    <button id="toggle-activity" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Show Activity Log
    </button>
    <button id="clear-activity" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Clear Activity
    </button>
  </div>
  <div id="activity-log" style="display: none; margin-bottom: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f8f9fa;">
    <h4 style="margin-top: 0;">Webhook Activity Log</h4>
    <div id="activity-list"></div>
  </div>
  <p>Recent form submissions requiring manual Referral processing:</p>
  <div id="submissions">
    <p>Loading submissions...</p>
  </div>
  <script>
    function loadSubmissions() {
      fetch('/recent-submissions?limit=20')
        .then(response => response.json())
        .then(data => {
          const container = document.getElementById('submissions');
          if (data.submissions.length === 0) {
            container.innerHTML = '<p>No recent submissions found.</p>';
            return;
          }
          const template = data.submissions
            .map(function(submission) {
              return (
                '<div class="submission">' +
                  '<div class="email">üìß ' + submission.email + '</div>' +
                  '<div class="timestamp">‚è∞ ' + new Date(submission.timestamp).toLocaleString() + '</div>' +
                  '<div class="instructions">' +
                    '<strong>Instructions:</strong><br />' +
                    '1. Click &#34;üîó Open Referral + Auto-fill&#34; below<br />' +
                    '2. The extension will auto-detect and fill the email<br />' +
                    '3. Click &#34;Envoyer par e-mail&#34; to send the referral<br />' +
                    '<br />' +
                    '<strong>Email to fill:</strong> <code>' + submission.email + '</code>' +
                  '</div>' +
                  '<div class="link">' +
                    '<a href="' + submission.referralInfo.directLink + '" target="_blank" style="background: #28a745;">' +
                      'üîó Open Referral + Auto-fill' +
                    '</a>' +
                    '<button class="copy-button" onclick="copyToClipboard(\'' + submission.email.replace(/'/g, "&#39;") + '\', this)" style="background: #17a2b8;">' +
                      'üìß Copy Email' +
                    '</button>' +
                  '</div>' +
                  '<details style="margin-top: 10px;">' +
                    '<summary>Manual Instructions</summary>' +
                    '<pre style="font-size: 12px; background: #f5f5f5; padding: 10px; border-radius: 4px;">' +
                      (submission.referralInfo.manualInstructions || submission.referralInfo.instructions || '') +
                    '</pre>' +
                  '</details>' +
                  '<small>Submission ID: ' + submission.submissionId + '</small>' +
                '</div>'
              );
            })
            .join("");
          container.innerHTML = template;
        })
        .catch(error => {
          console.error('Error loading submissions:', error);
          document.getElementById('submissions').innerHTML = '<p>Error loading submissions</p>';
        });
    }
    loadSubmissions();
    if (!!window.EventSource) {
      const evtSource = new EventSource('/events');
      evtSource.onopen = function() {
        console.log('[SSE] Connection to /events opened');
      };
      evtSource.onerror = function(e) {
        console.error('[SSE] Error:', e);
      };
      evtSource.onmessage = function(event) {
        console.log('[SSE] Message received:', event.data);
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'new_submission' || data.type === 'initial_data') {
            loadSubmissions();
          }
        } catch (e) {
          console.error('[SSE] Parse error:', e);
        }
      };
    }
    function openPopupAndFill(url, email, button) {
      const originalText = button.textContent;
      button.textContent = '‚è≥ Opening...';
      const popup = window.open(url, 'referral-popup', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      if (!popup) {
        alert('Popup blocked! Please allow popups for this site.');
        button.textContent = originalText;
        return;
      }
      let attempts = 0;
      const maxAttempts = 10;
      const fillEmail = () => {
        attempts++;
        try {
          const popupDoc = popup.document;
          if (popupDoc && popupDoc.readyState === 'complete') {
            const emailInput = popupDoc.getElementById('email') || 
              popupDoc.querySelector('input[name="email"]') ||
              popupDoc.querySelector('input[type="email"]') ||
              popupDoc.querySelector('.form-control[type="text"]');
            if (emailInput) {
              emailInput.value = email;
              emailInput.focus();
              emailInput.dispatchEvent(new Event('input', { bubbles: true }));
              emailInput.dispatchEvent(new Event('change', { bubbles: true }));
              button.textContent = '‚úÖ Filled!';
              setTimeout(() => {
                button.textContent = originalText;
              }, 3000);
              return;
            }
          }
          if (attempts < maxAttempts && !popup.closed) {
            setTimeout(fillEmail, 1000);
          } else {
            button.textContent = '‚ùå Failed';
            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);
          }
        } catch (e) {
          if (attempts < maxAttempts && !popup.closed) {
            setTimeout(fillEmail, 1000);
          } else {
            button.textContent = '‚ùå Auto-fill failed';
            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);
          }
        }
      };
      setTimeout(fillEmail, 2000);
    }
    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text).then(function() {
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        button.style.background = '#28a745';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '#ffc107';
        }, 2000);
      }).catch(function(err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        button.style.background = '#28a745';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '#ffc107';
        }, 2000);
      });
    }
  </script>
</body>
</html>
